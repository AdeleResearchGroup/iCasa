<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--
 | Generated by Apache Maven Doxia at 2014-03-09
 | Rendered using Apache Maven Fluido Skin 1.2.2
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iCasa</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido.min.js"></script>

          
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/site.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="stylesheet" type="text/css" href="./css/font-awesome.css"/>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<script type="text/javascript">var _gaq = _gaq || [];
                _gaq.push(['_setAccount', 'UA-35847694-2']);
                _gaq.push(['_trackPageview']);

                (function() {
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
                })();</script>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<script type="text/javascript">$(document).ready(function () {
                $("pre code").parent().addClass("prettyprint");
                prettyPrint();
                });</script>
      
                
        <?xml version="1.0" encoding="UTF-8"?>
<link rel="shortcut icon" href="favicon.png"/>
          
    <meta name="Date-Revision-yyyymmdd" content="20140309" />
    <meta http-equiv="Content-Language" content="en" />
            </head>
        <body class="topBarDisabled">
          
    
    
            
    
        
    <a href="http://github.com/AdeleResearchGroup/iCasa">
      <img style="position: absolute; top: 0; right: 0; border: 0; z-index: 100;"
        src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"
        alt="Fork me on GitHub">
    </a>
  
                
                    
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                                  <a href="#" id="bannerLeft">
                                                                                                <img src="icasa-small.png"  alt="iCasa - Digital Home Platform and Simulator Tool"/>
                </a>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2014-03-09</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 1.2.6-SNAPSHOT</li>
                      
                
                    
      
                            </ul>
      </div>

            <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
                
                    
                                    <h3>iCasa</h3>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Home">Home</a>
            </li>
                  <li class="none">
                          <a href="license.html" title="License">License</a>
            </li>
                  <li class="none">
                          <a href="overview.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="architecture.html" title="Architecture">Architecture</a>
            </li>
                  <li class="none">
                          <a href="download.html" title="Download">Download</a>
            </li>
                  <li class="none">
                          <a href="install.html" title="Install">Install</a>
            </li>
                  <li class="none">
                          <a href="requires-device.html" title="Device Injection in iCasa">Device Injection in iCasa</a>
            </li>
                  <li class="none">
                          <a href="trackers.html" title="iCasa Trackers">iCasa Trackers</a>
            </li>
                  <li class="none">
                          <a href="technical-services.html" title="Technical Services">Technical Services</a>
            </li>
                  <li class="none">
                          <a href="faq.html" title="FAQ">FAQ</a>
            </li>
          </ul>
                        <h3>User Guide</h3>
                  <ul>
                  <li class="none">
                          <a href="guide.html" title="Simulator GUI Guide">Simulator GUI Guide</a>
            </li>
                                                              <li class="expanded">
                          <a href="#" title="First App">First App</a>
                    <ul>
                      <li class="none">
                          <a href="tutoIDE.html" title="With iCasa IDE">With iCasa IDE</a>
            </li>
              </ul>
        </li>
                  <li class="none">
                          <a href="script.html" title="Script Language">Script Language</a>
            </li>
                  <li class="none">
                          <a href="rest-api.html" title="REST API">REST API</a>
            </li>
                  <li class="none">
                          <a href="gogo-commands.html" title="Gogo commands">Gogo commands</a>
            </li>
                  <li class="none">
                          <a href="building-device.html" title="Device Building Tutorial">Device Building Tutorial</a>
            </li>
                  <li class="none">
                          <a href="apidocs/index.html" title="Javadoc">Javadoc</a>
            </li>
          </ul>
                        <h3>Advanced tutorials</h3>
                  <ul>
                  <li class="none">
            <strong>Building iCasa Commands</strong>
          </li>
          </ul>
                        <h3>Simulated Devices</h3>
                  <ul>
                  <li class="none">
                          <a href="lights.html" title="Lights">Lights</a>
            </li>
                  <li class="none">
                          <a href="heater.html" title="Heater/Cooler">Heater/Cooler</a>
            </li>
                  <li class="none">
                          <a href="detectors.html" title="Detectors">Detectors</a>
            </li>
          </ul>
                      
                    
                            <form id="search-form" action="http://www.google.com/search" method="get" >
    
  <input value="http://adeleresearchgroup.github.com/iCasa" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" />
</form>
<script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=search-form"></script>
          
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
        <div id="bodyColumn"  class="span10" >
                                  
            <h1>How to build an iCasa Command</h1>

<ul>
<li><a href="#Requirements">Tutorial Requirements</a></li>
<li><a href="#Model">iCasa Command Model</a>
<ul><li><a href="#Interface">iCasa Command Interface</a></li>
<li><a href="#Signature">Command Signature</a></li></ul></li>
<li><a href="#Implementation">iCasa Command Implementation</a>
<ul><li><a href="#Implementation_No_Parameters">Command without parameters</a></li>
<li><a href="#Implementation_Parameters">Command with parameters</a></li></ul></li>
<li><a href="#Usage">iCasa Command Usage</a></li>
<li><a href="#Packaging">Project Packaging</a>
<ul><li><a href="#POM">POM</a></li></ul></li>
</ul>

<p><a name="Requirements"></a></p>

<h2>Tutorial Requirements</h2>

<ul>
<li>OSGi &amp; iPOJO : iCasa is built on top of <a href="http://www.osgi.org">OSGi</a> platform and <a href="http://felix.apache.org/site/apache-felix-ipojo.html">iPOJO</a> component model. This tutorial is made using <a href="http://felix.apache.org/site/how-to-use-ipojo-annotations.html">iPOJO annotations</a>.</li>
<li>Maven (Optional) : <a href="http://maven.apache.org/">Maven</a> tool can be used to build new iCasa commands.</li>
<li>JSON: The <a href="http://www.json.org/">JSON</a> format is used to passed parameters to iCasa commands</li>
</ul>

<p><a name="Model"></a></p>

<h2>iCasa Command Model</h2>

<p>iCasa platform provides a command architecture allowing extension by third party developers. This architecture is based on the <a href="http://www.osgi.org/wiki/uploads/Links/whiteboard.pdf">OSGi whiteboard pattern</a>. In this tutorial we will show how to add new commands to the iCasa platform.</p>

<p>iCasa Commands could be used two different ways:</p>

<ul>
<li>Using the gogo shell. Interacting with the shell it is possible to call <a href="./gogo-commands.html">iCasa commands</a>.</li>
<li>Using iCasa scripts. It is possible to use the commands from an <a href="./script.html">iCasa script file</a> .</li>
</ul>

<p>This benefits the platform in two main ways:</p>

<ul>
<li>commands allow to introspect the information of the current simulation (usually in the shell mode).</li>
<li>commands allow to modify the state of elements in current simulation.</li>
</ul>

<p><a name="Interface"></a></p>

<h3>iCasa Command Interface</h3>

<p>In order to add a new command to the iCasa platform, an OSGi service must be provided by the developer. This service has to implement the <em>fr.liglab.adele.icasaICasaCommand</em> interface, it is show below</p>

<pre><code>/**
 * An ICommandService is a service that can be executed with a set of arguments. It can execute a block of code and then
 * returns the result object of executing this code.
 */
public interface ICasaCommand {
    /**
     * Execute a block of code and then returns the result from execution. This method should use {@code in} and
     * {@code out} stream to print result instead of the direct use of {@code System.in} and {@code System.out}
     * 
     * @param in : the input stream.
     * @param out : the output stream.
     * @param param a json object of parameters
     * 
     * @return the result from the execution
     * @throws Exception if anything goes wrong
     */
    Object execute(InputStream in, PrintStream out, JSONObject param) throws Exception;

    /**
     * To validate the given parameters.
     * 
     * @param param The parameters in JSON format
     * @return true if parameters are valid, false if not.
     * @throws Exception
     */
    boolean validate(JSONObject param, Signature signature) throws Exception;

    /**
     * Get the command description.
     * 
     * @return The description of the Script and command gogo.
     */
    String getDescription();

    /**
     * Get the name of the Script and command gogo.
     * 
     * @return The command name.
     */
    String getName();

    /**
     * Get signature by passing the number of arguments..
     * 
     * @return
     */
    Signature getSignature(int size);

}
</code></pre>

<ul>
<li>The  <em>getName()</em> method provides the command name (used in the shell as command).</li>
<li>The <em>getDescription()</em> method is called by the platform when users are looking for help of this command.</li>
<li>The <em>validate(JSONObject param, Signature signature)</em> method is invoked to validate parameters provided to the command. The validation is realized against a command signature.</li>
<li>The <em>getSignature(int size)</em> must return a command signature of the provided size.</li>
<li>The <em>execute(InputStream in, PrintStream out, JSONObject param)</em> will execute the set of instructions defining the iCasa command. This method is called by the platform after invocation of <em>validate</em> method and only if it returned true. The <em>in</em> and <em>out</em> parameter correspond to the standard input stream and output stream. Finally, the JSON object <em>param</em> contains the values of command parameters.</li>
</ul>

<p><a name="Signature"></a></p>

<h3>Command Signature</h3>

<p>A command <strong>signature</strong> defines number and order of its parameters. When a command is used in the shell arguments are anonymous, iCasa platform determines the parameter correspondence only based in order. On the other hand, if the command is used in a script file, parameters are determined based on their names.</p>

<p>Commands could have more than one signature, however signatures cannot contain the same number of parameters. The <em>fr.liglab.adele.icasa.Signature</em> class is presented in the next code snipped, to create a Signature only is necessary to provide an array of string corresponding to the name of parameters in the expected order (see constructor).</p>

<pre><code>public class Signature {

    /**
     * The list of parameters for a given iCasaCommand signature.
     */
    private final String[] parameters;

    public Signature(String[] params) {
        this.parameters = params;
    }

    /**
     * Get the list of parameters of this signature.
     * 
     * @return the list of parameters.
     */
    public String[] getParameters() {
        return parameters;
    }

    ...
}
</code></pre>

<p><a name="Implementation"></a></p>

<h2>iCasa Command Implementation</h2>

<p>In order to facilitate the creation of iCasa Commands, the abstract class <em>fr.liglab.adele.icasa.commands.impl.AbstractCommand</em>  is provided by the iCasa platform. This class implements the <em>ICasaCommand</em> interface, it implements the <em>validate</em> and <em>getSignature</em> methods.</p>

<p>A command implementation should extend the AbstractCommand and implements the <em>getName</em>, <em>getDescription</em> and <em>execute</em> methods. In addition, in the constructor of the implementation class must be defined the signatures of the command using the method <em>addSignature</em>. Finally, the implementation class must be annotated with the iPOJO annotations to expose itself as OSGi a service, this service will implement the right interface <em>ICasaCommand</em>. </p>

<p>In order to illustrate how to create iCasa commands will show to different examples, the first one using no parameters, and other using parameters.</p>

<p><a name="Implementation_No_Parameters"></a></p>

<h3>Command without parameters</h3>

<p>The following command displays the list of current devices in the iCasa platform. It does not take any parameter.</p>

<pre><code>    @Component(name = "ShowDevicesCommand")
    @Provides
    @Instantiate(name="show-devices-command")
    public class ShowDevicesCommand extends AbstractCommand {

        @Requires
        private ContextManager manager;

        /**
         * Get the name of the  Script and command gogo.
         *
         * @return The command name.
         */
        @Override
        public String getName() {
            return "show-devices";
        }

        public ShowDevicesCommand(){
            addSignature(new Signature(new String[0])); // Adding an empty signature, without parameters
        }

        @Override
        public Object execute(InputStream in, PrintStream out, JSONObject param, Signature signature) throws Exception {
            out.println("Devices: ");
            List&lt;LocatedDevice&gt; devices = manager.getDevices();
            for (LocatedDevice locatedDevice : devices) {
                out.println("Device " + locatedDevice);
            }
            return null;
        }

        @Override
        public String getDescription(){
            return "Shows the list of devices.\n\t" + super.getDescription();
        }

    }
</code></pre>

<p><a name="Implementation_Parameters"></a></p>

<h3>Command with parameters</h3>

<p>The following command displays the details of a particular device. </p>

<pre><code>    @Component(name = "ShowDeviceCommand")
    @Provides
    @Instantiate(name = "show-device-command")
    public class ShowDeviceInfoCommand extends AbstractCommand {

        @Requires
        private ContextManager simulationManager;

        public ShowDeviceInfoCommand(){
            addSignature(new Signature(new String[]{"deviceId"})); // Adding a signatue with one parameter named deviceId
        }

        /**
         * Get the name of the  Script and command gogo.
         *
         * @return The command name.
         */
        @Override
        public String getName() {
            return "show-device";
        }

        @Override
        public Object execute(InputStream in, PrintStream out, JSONObject param, Signature signature) throws Exception {
            String[] params = signature.getParameters();
            String deviceId = param.getString(params[0]);
            out.println("Properties: ");
            LocatedDevice device = simulationManager.getDevice(deviceId);
            if (device==null) {
                throw new IllegalArgumentException("Device ("+ deviceId +") does not exist");
            }
            Set&lt;String&gt; properties = device.getProperties();
            for (String property : properties) {
                out.println("Property: " + property + " - Value: " +device.getPropertyValue(property));
            }
            return null;
        }

        @Override
        public String getDescription(){
            return "Shows the information of a device.\n\t" + super.getDescription();
        }

    }
</code></pre>

<p><a name="Usage"></a></p>

<h2>iCasa Command Usage</h2>

<p>As said before, iCasa Commands has two usages, the first one to be called from the shell, and the other one to be used from an iCasa Script.</p>

<h3>OSGi Shell</h3>

<p>To see the parameter order in the shell, we can call the icasa:help command, which will show the commands description, as well as the parameters list.</p>

<pre><code>g!icasa:help

icasa:show-zones
    Shows the list of zones.
    Parameters: 
    ()
icasa:move-person
    Move a person to a new X,Y position.
    Parameters: 
    ( personId  newX  newY )
    ( personId  newX  newY  newZ )
g!
</code></pre>

<p>So, for example, to move a person, we have two signatures with three and four parameters respectively:</p>

<pre><code>g! move-person Jean 40 40
</code></pre>

<p>and</p>

<pre><code>g! move-person Jean 50 50 50
</code></pre>

<h3>iCasa Scripts</h3>

<p>iCasa provides a mechanism to execute scripts. This is presented in the <a href="script.html">script</a> section. But also, the script language can be extended by using commands. So, new commands could be executed in a given script.
The command name (the string returned in the getName() method)  must be represented by an XML tag. And the parameters are represented by the attributes contained in those tags.</p>

<p>For example, it is possible to move a person by putting in the script the following:</p>

<pre><code>&lt;move-person personId="Jean" newX="40" newY="40"/&gt;
</code></pre>

<p>or</p>

<pre><code>&lt;move-person personId="Jean" newX="50" newY="50" newZ="50"/&gt;
</code></pre>

<p><a name="Packaging"></a></p>

<h2>Project Packaging</h2>

<p>You can use <a href="http://felix.apache.org/site/apache-felix-ipojo.html">maven</a> tool to build a command project. Two iCasa maven artifacts are necessary to build your project, the first one context.api defines the interfaces used in the Command model, the context.impl provides the AbstractCommand class.</p>

<p>Artifacs :</p>

<p><strong><em>Context API - iCasa Command interfaces</em></strong></p>

<pre><code>&lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
&lt;artifactId&gt;context.api&lt;/artifactId&gt;
&lt;version&gt;1.1.2-SNAPSHOT&lt;/version&gt;
</code></pre>

<p><strong><em>Context Impl - iCasa Command abstract class</em></strong></p>

<pre><code>&lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
&lt;artifactId&gt;context.impl&lt;/artifactId&gt;
&lt;version&gt;1.1.2-SNAPSHOT&lt;/version&gt;
</code></pre>

<p>Repositories :  </p>

<pre><code>&lt;repositories&gt;
  &lt;repository&gt;
    &lt;snapshots&gt;
      &lt;enabled&gt;false&lt;/enabled&gt;
    &lt;/snapshots&gt;
    &lt;id&gt;adele-central-release&lt;/id&gt;
    &lt;name&gt;adele-repos&lt;/name&gt;
    &lt;url&gt;http://repository-icasa.forge.cloudbees.com/release&lt;/url&gt;
  &lt;/repository&gt;
  &lt;repository&gt;
    &lt;snapshots /&gt;
    &lt;id&gt;snapshots&lt;/id&gt;
    &lt;name&gt;adele-central-snapshot&lt;/name&gt;
    &lt;url&gt;http://repository-icasa.forge.cloudbees.com/snapshot&lt;/url&gt;
  &lt;/repository&gt;
&lt;/repositories&gt;
</code></pre>

<p><a name="POM"></a>  </p>

<h3>Command Pom Model File</h3>

<p>This is an extract of a maven project using the needed dependencies to build iCasa Commands. Also it shows dependencies for OSGi and iPOJO bundles, as well as their plugins configuration.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
   &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

   &lt;!-- Project coordinates --&gt;
   &lt;artifactId&gt;myCommand.project&lt;/artifactId&gt;
   &lt;packaging&gt;bundle&lt;/packaging&gt;
   &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;

   &lt;!-- Project repositories --&gt;
   &lt;repositories&gt;
     &lt;repository&gt;
       &lt;snapshots&gt;
        &lt;enabled&gt;false&lt;/enabled&gt;
       &lt;/snapshots&gt;
       &lt;id&gt;adele-central-release&lt;/id&gt;
       &lt;name&gt;adele-repos&lt;/name&gt;
       &lt;url&gt;http://repository-icasa.forge.cloudbees.com/release&lt;/url&gt;
     &lt;/repository&gt;
    &lt;repository&gt;
      &lt;snapshots /&gt;
      &lt;id&gt;snapshots&lt;/id&gt;
      &lt;name&gt;adele-central-snapshot&lt;/name&gt;
      &lt;url&gt;http://repository-icasa.forge.cloudbees.com/snapshot&lt;/url&gt;
     &lt;/repository&gt;
   &lt;/repositories&gt;

   &lt;!-- Project dependencies --&gt;
   &lt;dependencies&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.osgi&lt;/groupId&gt;
         &lt;artifactId&gt;org.osgi.core&lt;/artifactId&gt;
         &lt;version&gt;4.2.0&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
         &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
         &lt;artifactId&gt;org.apache.felix.ipojo&lt;/artifactId&gt;
         &lt;version&gt;1.10.1&lt;/version&gt;
      &lt;/dependency&gt;  
      &lt;dependency&gt;
         &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
         &lt;artifactId&gt;org.apache.felix.ipojo.annotations&lt;/artifactId&gt;
         &lt;version&gt;1.10.1&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
         &lt;artifactId&gt;context.api&lt;/artifactId&gt;
         &lt;version&gt;1.0.1-SNAPSHOT&lt;/version&gt;
      &lt;/dependency&gt;
      &lt;dependency&gt;
        &lt;groupId&gt;fr.liglab.adele.icasa&lt;/groupId&gt;
        &lt;artifactId&gt;context.impl&lt;/artifactId&gt;
        &lt;version&gt;1.0.1-SNAPSHOT&lt;/version&gt;
      &lt;/dependency&gt;
   &lt;/dependencies&gt;

   &lt;build&gt;
     &lt;plugins&gt;
       &lt;plugin&gt;
          &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
          &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
          &lt;version&gt;2.3.7&lt;/version&gt;
          &lt;configuration&gt;
            &lt;instructions&gt;
               &lt;Private-Package&gt;fr.liglab.adele.icasa.zones.command.impl&lt;/Private-Package&gt;
            &lt;/instructions&gt;
          &lt;/configuration&gt;
        &lt;/plugin&gt;
     &lt;plugin&gt;
       &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
       &lt;artifactId&gt;maven-ipojo-plugin&lt;/artifactId&gt;
       &lt;version&gt;1.8.6&lt;/version&gt;
     &lt;/plugin&gt;
   &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>

<p></project></p>

                  </div>
            </div>
      
    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2012-2014
                        <a href="http://www-adele.imag.fr/">ADELE Research Group</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  </body>
</html>
